!function(e,a){"object"==typeof exports&&"undefined"!=typeof module?a(exports):"function"==typeof define&&define.amd?define(["exports"],a):a((e=e||self)["@wt/lib-wtda-query"]={})}(this,(function(e){"use strict";const a=require("lodash"),t=require("os"),i=require("path"),n=require("fs"),r=n.promises,o=require("pino")({level:process.env.LOGGER||"info",prettyPrint:{levelFirst:!0,translateTime:"SYS:yyyy-mm-dd HH:MM:ss.l",crlf:!0},prettifier:require("pino-pretty")}),s={daily:"daily",info:"info",financial:"fin"};function c(){return i.join(t.homedir(),".wtda")}const d={daily:"daily",adjustFactor:"adjustFactor",suspendInfo:"suspendInfo",dailyBasic:"dailyBasic",moneyFlow:"moneyFlow",indexDaily:"indexDaily",income:"income",balanceSheet:"balanceSheet",cashFlow:"cashFlow",forecast:"forecast",express:"express",dividend:"dividend",financialIndicator:"financialIndicator",financialMainbiz:"financialMainbiz",disclosureDate:"disclosureDate",pledgeStat:"pledgeStat",pledgeDetail:"pledgeDetail",trend:"trend"},l={daily:{name:"daily",path:s.daily,ext:""},adjustFactor:{name:"adjustFactor",path:s.daily,ext:".adj"},suspendInfo:{name:"suspendInfo",path:s.info,ext:".sus"},dailyBasic:{name:"dailyBasic",path:s.info,ext:".bsc"},moneyFlow:{name:"moneyFlow",path:s.info,ext:".mf"},indexDaily:{name:"indexDaily",path:s.daily,ext:""},income:{name:"income",path:s.financial,ext:".ic"},balanceSheet:{name:"balanceSheet",path:s.financial,ext:".bs"},cashFlow:{name:"cashFlow",path:s.financial,ext:".cf"},forecast:{name:"forecast",path:s.financial,ext:".fc"},express:{name:"express",path:s.financial,ext:".ep"},dividend:{name:"dividend",path:s.financial,ext:".dd"},financialIndicator:{name:"financialIndicator",path:s.financial,ext:".id"},financialMainbiz:{name:"financialMainbiz",path:s.financial,ext:".mb"},disclosureDate:{name:"disclosureDate",path:s.financial,ext:".dt"},pledgeStat:{name:"pledgeStat",path:s.financial,ext:".ps"},pledgeDetail:{name:"pledgeDetail",path:s.financial,ext:".pd"},trend:{name:"trend",path:s.daily,ext:".tr"}};function f(e,t){let n=l[e];if(!n)throw new Error("不支持的数据类型"+e);if(a.isEmpty(t))throw new Error("未设置读取股票代码");return i.join(c(),n.path,t+n.ext+".json")}async function p(){let e=c();try{await r.access(e,n.constants.F_OK|n.constants.R_OK|n.constants.W_OK)}catch(a){o.debug("检查数据根目录错误 "+a),await r.mkdir(e,{recursive:!0})}for(let a of Object.keys(s)){let t=i.join(e,s[a]);try{await r.access(t,n.constants.F_OK|n.constants.R_OK|n.constants.W_OK)}catch(e){o.debug(`检查目录${s[a]}错误 ${e}`),await r.mkdir(t,{recursive:!0})}}}p(),e.DATA_PATH=s,e.INDEXLIST_FILE="index-list.json",e.STOCKLIST_FILE="stock-list.json",e.getDataRoot=c,e.getStockDataFile=f,e.readStockData=async function(e,t){if(!d[e])throw new Error("不支持的数据类型："+e);if(a.isEmpty(t))throw new Error("未设置读取股票代码");let i={updateTime:null,data:[]},n=l[e];try{await p();let a=f(e,t);o.debug(`读取本地数据 ${t}.${e}，参数配置 %o，文件 ${a}`,n);try{i=JSON.parse(await r.readFile(a,"utf-8"))}catch(n){n&&"ENOENT"===n.code?o.debug(`读取${t}的${e}文件${a}不存在，%o`,n):o.error(`读取${t}的${e}文件${a}时发生错误：${n}, %o`,n),i={data:[]}}}catch(a){o.error(`从本地读取个股数据${e}时发生错误 ${a}`)}return i},e.readStockIndexList=async function(){let e=null;try{await p();let t=i.join(c(),"index-list.json");e=JSON.parse(await r.readFile(t,"utf-8")),a.isEmpty(e)||o.debug("指数列表更新时间 @"+e.updateTime)}catch(e){throw o.error("读取指数列表数据错误："+e),new Error("读取指数列表过程中出现错误，请检查后重新运行："+e)}return a.isEmpty(e)?{updateTime:"",data:[]}:e},e.readStockList=async function(){let e=null;try{await p();let t=i.join(c(),"stock-list.json");e=JSON.parse(await r.readFile(t,"utf-8")),a.isEmpty(e)||o.debug("股票列表更新时间 @"+e.updateTime)}catch(e){throw o.error("读取股票列表数据错误："+e),new Error("读取股票列表过程中出现错误，请检查后重新运行："+e)}return a.isEmpty(e)?{updateTime:"",data:[]}:e},e.stockDataNames=d,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=stockdata-query.js.map
